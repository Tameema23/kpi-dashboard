<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
  <title>Settings</title>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      KPI Dashboard
    </span>
    <nav class="topbar-nav" id="settings-topbar-nav">
      <a href="/index.html" class="admin-only">Home</a>
      <a href="/log.html" class="admin-only">Log Day</a>
      <a href="/reports.html" class="admin-only">Reports</a>
      <a href="/history.html" class="admin-only">History</a>
      <a href="/planner.html" class="admin-only">Planner</a>
      <a href="/quality.html" class="admin-only">Quality</a>
      <a href="/settings.html" class="active">Settings</a>
    </nav>
  </div>
  <div class="topbar-right">
    <span class="topbar-user">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span id="username-text"></span>
    </span>
    <button class="logout" onclick="logout()">Sign Out</button>
  </div>
</div>

<div class="page">
  <a class="back" id="backToDashboard" onclick="location.href='/index.html'">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
    Back to Dashboard
  </a>

  <div style="max-width: 560px;">

    <!-- Account Info Card -->
    <div class="card" style="margin-bottom: 22px;">
      <div class="settings-card-header">
        <div class="settings-icon icon-blue">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div>
          <h2 style="margin:0 0 2px 0; font-size:17px;">Account</h2>
          <p style="margin:0; font-size:13px; color:#64748b;">Your account information</p>
        </div>
      </div>
      <div class="settings-field">
        <span class="settings-label">Username</span>
        <span class="settings-value" id="display-username">—</span>
      </div>
    </div>

    <!-- Change Password Card -->
    <div class="card" style="margin-bottom: 22px;">
      <div class="settings-card-header">
        <div class="settings-icon icon-amber">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        </div>
        <div>
          <h2 style="margin:0 0 2px 0; font-size:17px;">Change Password</h2>
          <p style="margin:0; font-size:13px; color:#64748b;">Update your account password</p>
        </div>
      </div>

      <input type="text" style="display:none" aria-hidden="true">
      <input type="password" style="display:none" aria-hidden="true">

      <div class="form-field" style="margin-top: 20px;">
        <label>Current Password</label>
        <div class="pw-field-wrap">
          <input id="current_password" type="password" placeholder="Enter current password" autocomplete="new-password">
          <button type="button" class="pw-toggle-btn" onclick="togglePw('current_password', this)" title="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
      <div class="form-field">
        <label>New Password</label>
        <div class="pw-field-wrap">
          <input id="new_password" type="password" placeholder="Enter new password" autocomplete="new-password">
          <button type="button" class="pw-toggle-btn" onclick="togglePw('new_password', this)" title="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>
      <div class="form-field">
        <label>Confirm New Password</label>
        <div class="pw-field-wrap">
          <input id="confirm_password" type="password" placeholder="Confirm new password" autocomplete="new-password">
          <button type="button" class="pw-toggle-btn" onclick="togglePw('confirm_password', this)" title="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
        </div>
      </div>

      <div style="display:flex; align-items:center; gap:14px; margin-top:8px;">
        <button class="btn" onclick="changePassword()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
          Save Password
        </button>
        <span id="pw-msg" style="font-size:13px; font-weight:600;"></span>
      </div>
    </div>

    <!-- Assistant Accounts Card (admin only) -->
    <div class="card" id="assistantCard" style="display:none;">
      <div class="settings-card-header">
        <div class="settings-icon icon-purple">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <div>
          <h2 style="margin:0 0 2px 0; font-size:17px;">Assistant Accounts</h2>
          <p style="margin:0; font-size:13px; color:#64748b;">Manage assistants and their access permissions</p>
        </div>
      </div>

      <!-- Existing assistants list -->
      <div id="assistantList" style="margin-bottom:20px;"></div>

      <!-- Create new assistant -->
      <div style="border-top:2px solid #f1f5f9; padding-top:18px;">
        <p style="margin:0 0 14px 0; font-size:13px; font-weight:700; color:#475569; text-transform:uppercase; letter-spacing:0.05em;">Add New Assistant</p>
        <div class="form-field">
          <label>Username</label>
          <input id="new_assistant_username" placeholder="e.g. sarah_assistant" type="text" autocomplete="off">
        </div>
        <div class="form-field">
          <label>Password</label>
          <div class="pw-field-wrap">
            <input id="new_assistant_password" placeholder="Set a password" type="password" autocomplete="new-password">
            <button type="button" class="pw-toggle-btn" onclick="togglePw('new_assistant_password', this)" title="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
          </div>
        </div>
        <div class="form-field">
          <label>Access Permissions</label>
          <div style="display:flex;gap:10px;margin-top:4px;">
            <label style="display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:2px solid #e2e8f0;background:#fafafa;cursor:pointer;font-size:13px;font-weight:600;color:#475569;flex:1;transition:all 0.15s;" id="perm_planner_label">
              <input type="checkbox" id="new_can_planner" checked style="accent-color:#7c3aed;width:16px;height:16px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Planner
            </label>
            <label style="display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:2px solid #e2e8f0;background:#fafafa;cursor:pointer;font-size:13px;font-weight:600;color:#475569;flex:1;transition:all 0.15s;" id="perm_quality_label">
              <input type="checkbox" id="new_can_quality" style="accent-color:#16a34a;width:16px;height:16px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
              Quality
            </label>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:14px; margin-top:4px;">
          <button class="btn" onclick="createAssistant()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Create Assistant
          </button>
          <span id="assistant-msg" style="font-size:13px; font-weight:600;"></span>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Mobile Bottom Nav -->
<nav class="bottom-nav">
  <div class="bottom-nav-items">
    <a href="/index.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
    <a href="/log.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Log
    </a>
    <a href="/reports.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reports
    </a>
    <a href="/history.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      History
    </a>
    <a href="/planner.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Planner
    </a>
    <a href="/quality.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      Quality
    </a>
    <a href="/settings.html" class="bottom-nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </a>
  </div>
</nav>

<!-- Edit Permissions Modal -->
<div class="modal-backdrop hidden" id="permissionsModal">
  <div class="modal-card" style="max-width:380px;">
    <div class="modal-header">
      <h3 id="permModalTitle">Edit Permissions</h3>
      <button class="modal-close" onclick="closePermModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;color:#64748b;margin:0 0 18px 0;">Select which sections this assistant can access. At least one must be enabled.</p>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <label id="perm_modal_planner_label" style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;border:2px solid #e2e8f0;background:#fafafa;cursor:pointer;transition:all 0.15s;">
          <input type="checkbox" id="perm_modal_planner" style="width:18px;height:18px;accent-color:#7c3aed;flex-shrink:0;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:34px;height:34px;border-radius:8px;background:#f5f3ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </div>
            <div>
              <div style="font-size:14px;font-weight:700;color:#0f172a;">Planner</div>
              <div style="font-size:12px;color:#94a3b8;">Appointment scheduling</div>
            </div>
          </div>
        </label>
        <label id="perm_modal_quality_label" style="display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;border:2px solid #e2e8f0;background:#fafafa;cursor:pointer;transition:all 0.15s;">
          <input type="checkbox" id="perm_modal_quality" style="width:18px;height:18px;accent-color:#16a34a;flex-shrink:0;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:34px;height:34px;border-radius:8px;background:#f0fdf4;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#16a34a" stroke-width="2.5"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
            </div>
            <div>
              <div style="font-size:14px;font-weight:700;color:#0f172a;">Quality Tracker</div>
              <div style="font-size:12px;color:#94a3b8;">Policy retention tracking</div>
            </div>
          </div>
        </label>
      </div>
      <p style="font-size:12px;color:#94a3b8;margin:14px 0 0 0;">&#9432; The assistant must sign out and back in for changes to take effect in their navigation.</p>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="savePermissions()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
        Save Permissions
      </button>
      <button class="btn" style="background:#f1f5f9;color:#475569;" onclick="closePermModal()">Cancel</button>
    </div>
  </div>
</div>

<script src="/static/app.js"></script>
<script>
  const u = localStorage.getItem("username");
  if (u) {
    document.getElementById("username-text").innerText = u;
    document.getElementById("display-username").innerText = u;
  }

  var _role = localStorage.getItem("role");
  if (_role === "assistant") {
    document.querySelectorAll(".admin-only").forEach(function(el) { el.style.display = "none"; });
    var backBtn = document.getElementById("backToDashboard");
    if (backBtn) backBtn.style.display = "none";
  }

  // ── Permission checkbox visual feedback ────────────────────────
  function updatePermLabel(checkboxId, labelId, activeColor) {
    var cb = document.getElementById(checkboxId);
    var lb = document.getElementById(labelId);
    if (!cb || !lb) return;
    if (cb.checked) {
      lb.style.borderColor = activeColor;
      lb.style.background  = activeColor === "#7c3aed" ? "#f5f3ff" : "#f0fdf4";
      lb.style.color       = activeColor === "#7c3aed" ? "#5b21b6" : "#166534";
    } else {
      lb.style.borderColor = "#e2e8f0";
      lb.style.background  = "#fafafa";
      lb.style.color       = "#475569";
    }
  }
  document.getElementById("new_can_planner").addEventListener("change", function() {
    updatePermLabel("new_can_planner", "perm_planner_label", "#7c3aed");
  });
  document.getElementById("new_can_quality").addEventListener("change", function() {
    updatePermLabel("new_can_quality", "perm_quality_label", "#16a34a");
  });
  // Set initial state
  updatePermLabel("new_can_planner", "perm_planner_label", "#7c3aed");

  // ── Password ───────────────────────────────────────────────────
  async function changePassword() {
    const current = document.getElementById("current_password").value;
    const newPw   = document.getElementById("new_password").value;
    const confirm = document.getElementById("confirm_password").value;
    const msg     = document.getElementById("pw-msg");
    if (!current || !newPw || !confirm) { msg.innerText = "Please fill in all fields."; msg.style.color = "#dc2626"; return; }
    if (newPw !== confirm) { msg.innerText = "New passwords do not match."; msg.style.color = "#dc2626"; return; }
    if (newPw.length < 4) { msg.innerText = "Password must be at least 4 characters."; msg.style.color = "#dc2626"; return; }
    const TOKEN = localStorage.getItem("token");
    try {
      const res = await fetch("/change-password", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + TOKEN },
        body: JSON.stringify({ current_password: current, new_password: newPw })
      });
      if (res.ok) {
        showToast("Password updated successfully!");
        document.getElementById("current_password").value = "";
        document.getElementById("new_password").value = "";
        document.getElementById("confirm_password").value = "";
        msg.innerText = "";
      } else {
        const data = await res.json();
        msg.innerText = data.detail || "Incorrect current password.";
        msg.style.color = "#dc2626";
      }
    } catch { msg.innerText = "Server error. Please try again."; msg.style.color = "#dc2626"; }
  }

  // ── Assistant management (admin only) ─────────────────────────
  if (_role === "admin" || !_role) {
    document.getElementById("assistantCard").style.display = "block";
    loadAssistants();
  }

  function permBadge(can_planner, can_quality) {
    var badges = [];
    if (can_planner) badges.push('<span style="display:inline-flex;align-items:center;gap:4px;background:#f5f3ff;color:#5b21b6;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:700;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Planner</span>');
    if (can_quality) badges.push('<span style="display:inline-flex;align-items:center;gap:4px;background:#f0fdf4;color:#166534;border-radius:6px;padding:2px 8px;font-size:11px;font-weight:700;"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 11l3 3L22 4"/></svg>Quality</span>');
    return badges.join(" ");
  }

  async function loadAssistants() {
    const TOKEN = localStorage.getItem("token");
    try {
      const res = await fetch("/assistants", { headers: { Authorization: "Bearer " + TOKEN } });
      if (!res.ok) return;
      const list = await res.json();
      const container = document.getElementById("assistantList");
      if (list.length === 0) {
        container.innerHTML = '<p style="font-size:13px;color:#94a3b8;margin:0;">No assistants yet.</p>';
        return;
      }
      container.innerHTML = list.map(function(a) {
        return '<div class="settings-field" style="align-items:flex-start;">' +
          '<div style="display:flex;flex-direction:column;gap:6px;">' +
            '<div style="display:flex;align-items:center;gap:10px;">' +
              '<div style="width:32px;height:32px;border-radius:50%;background:#f5f3ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' +
              '</div>' +
              '<div style="font-size:14px;font-weight:700;color:#0f172a;">' + a.username + '</div>' +
            '</div>' +
            '<div style="display:flex;gap:5px;flex-wrap:wrap;">' + permBadge(a.can_planner, a.can_quality) + '</div>' +
            '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
              '<button class="btn small" style="background:#f5f3ff;color:#5b21b6;font-size:11px;" onclick="editPermissions(' + a.id + ',\'' + a.username + '\',' + a.can_planner + ',' + a.can_quality + ')">Edit Permissions</button>' +
              '<button class="btn small" style="background:#fee2e2;color:#dc2626;font-size:11px;" onclick="removeAssistant(' + a.id + ',\'' + a.username + '\')">Remove</button>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join("");
    } catch(e) { console.error(e); }
  }

  async function createAssistant() {
    const username    = document.getElementById("new_assistant_username").value.trim();
    const password    = document.getElementById("new_assistant_password").value;
    const can_planner = document.getElementById("new_can_planner").checked;
    const can_quality = document.getElementById("new_can_quality").checked;
    const msg         = document.getElementById("assistant-msg");

    if (!username || !password) { msg.innerText = "Please fill in both fields."; msg.style.color = "#dc2626"; return; }
    if (password.length < 4) { msg.innerText = "Password must be at least 4 characters."; msg.style.color = "#dc2626"; return; }
    if (!can_planner && !can_quality) { msg.innerText = "Select at least one permission."; msg.style.color = "#dc2626"; return; }

    const TOKEN = localStorage.getItem("token");
    try {
      const res = await fetch("/create-assistant", {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + TOKEN },
        body: JSON.stringify({ username, password, can_planner, can_quality })
      });
      if (res.ok) {
        showToast("Assistant created!");
        document.getElementById("new_assistant_username").value = "";
        document.getElementById("new_assistant_password").value = "";
        document.getElementById("new_can_planner").checked = true;
        document.getElementById("new_can_quality").checked = false;
        updatePermLabel("new_can_planner", "perm_planner_label", "#7c3aed");
        updatePermLabel("new_can_quality", "perm_quality_label", "#16a34a");
        msg.innerText = "";
        loadAssistants();
      } else {
        const data = await res.json();
        msg.innerText = data.detail || "Failed to create.";
        msg.style.color = "#dc2626";
      }
    } catch { msg.innerText = "Server error."; msg.style.color = "#dc2626"; }
  }

  var _permEditId = null;
  var _permEditUsername = null;

  function editPermissions(id, username, currentPlanner, currentQuality) {
    _permEditId = id;
    _permEditUsername = username;
    document.getElementById("permModalTitle").innerText = "Edit — " + username;
    document.getElementById("perm_modal_planner").checked = !!(currentPlanner);
    document.getElementById("perm_modal_quality").checked = !!(currentQuality);
    updatePermModalStyle("perm_modal_planner", "perm_modal_planner_label", "#7c3aed", "#f5f3ff");
    updatePermModalStyle("perm_modal_quality", "perm_modal_quality_label", "#16a34a", "#f0fdf4");
    document.getElementById("permissionsModal").classList.remove("hidden");
  }

  function updatePermModalStyle(cbId, labelId, activeColor, activeBg) {
    var cb = document.getElementById(cbId);
    var lb = document.getElementById(labelId);
    if (cb.checked) {
      lb.style.borderColor = activeColor;
      lb.style.background  = activeBg;
    } else {
      lb.style.borderColor = "#e2e8f0";
      lb.style.background  = "#fafafa";
    }
  }

  document.getElementById("perm_modal_planner").addEventListener("change", function() {
    updatePermModalStyle("perm_modal_planner", "perm_modal_planner_label", "#7c3aed", "#f5f3ff");
  });
  document.getElementById("perm_modal_quality").addEventListener("change", function() {
    updatePermModalStyle("perm_modal_quality", "perm_modal_quality_label", "#16a34a", "#f0fdf4");
  });

  function closePermModal() {
    document.getElementById("permissionsModal").classList.add("hidden");
    _permEditId = null;
    _permEditUsername = null;
  }

  async function savePermissions() {
    var pl = document.getElementById("perm_modal_planner").checked;
    var ql = document.getElementById("perm_modal_quality").checked;
    if (!pl && !ql) { showToast("Select at least one permission.", "error"); return; }
    const TOKEN = localStorage.getItem("token");
    try {
      const res = await fetch("/assistants/" + _permEditId + "/permissions", {
        method: "PUT",
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + TOKEN },
        body: JSON.stringify({ can_planner: pl, can_quality: ql })
      });
      if (res.ok) {
        closePermModal();
        showToast(_permEditUsername + "'s permissions saved! They must re-login to see changes.");
        loadAssistants();
      } else {
        showToast("Failed to update.", "error");
      }
    } catch { showToast("Server error.", "error"); }
  }

  // Close on backdrop click
  document.getElementById("permissionsModal").addEventListener("click", function(e) {
    if (e.target === this) closePermModal();
  });

  function removeAssistant(id, name) {
    showConfirm(
      "Remove <strong>" + name + "</strong>? They will no longer be able to log in.",
      async function() {
        const TOKEN = localStorage.getItem("token");
        try {
          const res = await fetch("/assistants/" + id, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + TOKEN }
          });
          if (res.ok) { showToast(name + " removed."); loadAssistants(); }
          else showToast("Failed to remove.", "error");
        } catch { showToast("Server error.", "error"); }
      },
      { confirmText: "Remove", danger: false }
    );
  }

  function togglePw(inputId, btn) {
    var inp = document.getElementById(inputId);
    var showing = inp.type === 'text';
    inp.type = showing ? 'password' : 'text';
    btn.innerHTML = showing
      ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'
      : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
    btn.title = showing ? 'Show password' : 'Hide password';
  }
</script>
</body>
</html>