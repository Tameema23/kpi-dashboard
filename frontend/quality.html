<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <title>Quality Tracker</title>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      KPI Dashboard
    </span>
    <nav class="topbar-nav">
      <a href="/index.html" class="admin-only">Home</a>
      <a href="/log.html" class="admin-only">Log Day</a>
      <a href="/reports.html" class="admin-only">Reports</a>
      <a href="/history.html" class="admin-only">History</a>
      <a href="/planner.html" class="admin-only">Planner</a>
      <a href="/quality.html" class="active">Quality</a>
      <a href="/settings.html" class="admin-only">Settings</a>
    </nav>
  </div>
  <div class="topbar-right">
    <span class="topbar-user">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span id="username-text"></span>
    </span>
    <button class="logout" onclick="logout()">Sign Out</button>
  </div>
</div>

<div class="page">
  <a class="back admin-only" onclick="location.href='/index.html'">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
    Back to Dashboard
  </a>

  <div class="card">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; flex-wrap:wrap; gap:12px;">
      <div>
        <h2 style="margin:0 0 4px 0; font-size:20px; font-weight:800; color:#0f172a;">Quality Tracker</h2>
        <p style="margin:0; font-size:13px; color:#64748b;">Track policy retention and follow-up actions</p>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="btn" style="background:#f0fdf4;color:#166534;border:1.5px solid #bbf7d0;" onclick="exportQualityExcel()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export Excel
        </button>
        <button class="btn" onclick="openAddModal()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Entry
        </button>
      </div>
    </div>

    <div style="overflow-x:auto;">
      <table class="history-table">
        <thead>
          <tr>
            <th>Insured Name</th>
            <th>Policy #</th>
            <th>Remarks</th>
            <th>Date</th>
            <th>Phone</th>
            <th>Follow Up</th>
            <th>Action</th>
            <th>ALP</th>
            <th style="width:80px; text-align:center;">Edit</th>
            <th style="width:80px; text-align:center;">Delete</th>
          </tr>
        </thead>
        <tbody id="qualityBody">
          <tr>
            <td colspan="10" style="text-align:center; color:#94a3b8; padding:40px 0; font-size:14px;">
              No entries yet. Click "Add Entry" to get started.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Mobile Bottom Nav -->
<nav class="bottom-nav">
  <div class="bottom-nav-items">
    <a href="/index.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
    <a href="/log.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Log
    </a>
    <a href="/planner.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Planner
    </a>
    <a href="/quality.html" class="bottom-nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      Quality
    </a>
    <a href="/settings.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </a>
  </div>
</nav>

<!-- Add / Edit Modal -->
<div class="modal-backdrop hidden" id="qualityModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3 id="modalTitle">Add Entry</h3>
      <button class="modal-close" onclick="closeModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label>Insured Name <span style="color:#dc2626;">*</span></label>
        <input id="f_insured_name" type="text" placeholder="Full name">
      </div>
      <div class="form-field">
        <label>Policy Number</label>
        <input id="f_policy_number" type="text" placeholder="e.g. CD2589125">
      </div>
      <div class="form-field">
        <label>Remarks</label>
        <input id="f_remarks" type="text" placeholder="e.g. Reinstatement, APS, NOPRD...">
      </div>
      <div class="form-field">
        <label>Date</label>
        <input id="f_date" type="date">
      </div>
      <div class="form-field">
        <label>Phone Number</label>
        <input id="f_phone_number" type="text" placeholder="e.g. 780-555-0100">
      </div>
      <div class="form-field">
        <label>Follow Up</label>
        <input id="f_follow_up" type="text" placeholder="e.g. Hazem, Prodadj...">
      </div>
      <div class="form-field">
        <label>Action</label>
        <textarea id="f_action" rows="3" placeholder="Describe the action to take..."></textarea>
      </div>
      <div class="form-field">
        <label>ALP ($)</label>
        <input id="f_alp" type="text" placeholder="e.g. 1200.00">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="saveEntry()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
        Save
      </button>
      <button class="btn" style="background:#f1f5f9; color:#475569;" onclick="closeModal()">Cancel</button>
      <span id="modalMsg" style="font-size:13px; font-weight:600; color:#dc2626;"></span>
    </div>
  </div>
</div>

<script src="/static/app.js"></script>
<script>
  const u = localStorage.getItem("username");
  if (u) document.getElementById("username-text").innerText = u;

  // Role nav
  var _qualRole = localStorage.getItem("role");
  if (_qualRole === "assistant") {
    document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
    // Show planner link if they have planner access
    if (localStorage.getItem("can_planner") === "1") {
      document.querySelectorAll("a[href='/planner.html']").forEach(el => el.style.display = "");
    }
  }

  let entriesCache = [];
  let editingId    = null;

  // ── Excel Export ──────────────────────────────────────────────
  function exportQualityExcel() {
    if (!entriesCache || entriesCache.length === 0) {
      showToast("No entries to export.", "error");
      return;
    }
    var rows = [["Insured Name","Policy #","Remarks","Date","Phone Number","Follow Up","Action","ALP"]];
    entriesCache.forEach(function(e) {
      rows.push([
        e.insured_name  || "",
        e.policy_number || "",
        e.remarks       || "",
        e.date          || "",
        e.phone_number  || "",
        e.follow_up     || "",
        e.action        || "",
        e.alp           || ""
      ]);
    });
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.aoa_to_sheet(rows);
    // Column widths
    ws["!cols"] = [22,16,20,12,16,14,30,12].map(function(w){ return {wch:w}; });
    // Header style (SheetJS CE doesn't do styling, but width is enough)
    XLSX.utils.book_append_sheet(wb, ws, "Quality Tracker");
    var today = new Date().toLocaleDateString("en-CA").replace(/\//g,"-");
    XLSX.writeFile(wb, "quality_tracker_" + today + ".xlsx");
    showToast("Excel exported!");
  }

  // ── Load ──────────────────────────────────────────────────
  async function loadEntries() {
    try {
      const res = await fetch("/quality", {
        headers: { Authorization: "Bearer " + TOKEN }
      });
      if (!res.ok) return;
      entriesCache = await res.json();
      renderTable(entriesCache);
    } catch(e) { console.error(e); }
  }

  function renderTable(entries) {
    const tbody = document.getElementById("qualityBody");
    if (!entries || entries.length === 0) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;color:#94a3b8;padding:40px 0;font-size:14px;">No entries yet. Click "Add Entry" to get started.</td></tr>`;
      return;
    }
    tbody.innerHTML = entries.map(e => `
      <tr>
        <td style="font-weight:700; color:#0f172a;">${esc(e.insured_name)}</td>
        <td style="font-family:monospace; font-size:13px; color:#475569;">${esc(e.policy_number)}</td>
        <td>${esc(e.remarks)}</td>
        <td style="white-space:nowrap;">${fmtDate(e.date)}</td>
        <td>${esc(e.phone_number)}</td>
        <td>${e.follow_up ? `<span style="background:#eff6ff;color:#2563eb;padding:3px 10px;border-radius:20px;font-size:12px;font-weight:700;">${esc(e.follow_up)}</span>` : ""}</td>
        <td style="max-width:180px;white-space:normal;line-height:1.4;">${esc(e.action)}</td>
        <td style="font-weight:700;color:#16a34a;">${e.alp ? "$" + esc(e.alp) : ""}</td>
        <td style="text-align:center;">
          <button class="btn small" style="background:#eff6ff;color:#2563eb;" onclick="openEditModal(${e.id})" title="Edit">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          </button>
        </td>
        <td style="text-align:center;">
          <button class="btn small" style="background:#fee2e2;color:#dc2626;" onclick="deleteEntry(${e.id},'${esc(e.insured_name)}')" title="Delete">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
          </button>
        </td>
      </tr>
    `).join("");
  }

  // ── Modal ──────────────────────────────────────────────────
  function openAddModal() {
    editingId = null;
    document.getElementById("modalTitle").innerText = "Add Entry";
    clearForm();
    document.getElementById("qualityModal").classList.remove("hidden");
  }

  function openEditModal(id) {
    const entry = entriesCache.find(e => e.id === id);
    if (!entry) return;
    editingId = id;
    document.getElementById("modalTitle").innerText = "Edit Entry";
    document.getElementById("f_insured_name").value  = entry.insured_name  || "";
    document.getElementById("f_policy_number").value = entry.policy_number || "";
    document.getElementById("f_remarks").value       = entry.remarks       || "";
    document.getElementById("f_date").value          = entry.date          || "";
    document.getElementById("f_phone_number").value  = entry.phone_number  || "";
    document.getElementById("f_follow_up").value     = entry.follow_up     || "";
    document.getElementById("f_action").value        = entry.action        || "";
    document.getElementById("f_alp").value           = entry.alp           || "";
    document.getElementById("modalMsg").innerText = "";
    document.getElementById("qualityModal").classList.remove("hidden");
  }

  function closeModal() {
    document.getElementById("qualityModal").classList.add("hidden");
    editingId = null;
  }

  function clearForm() {
    ["f_insured_name","f_policy_number","f_remarks","f_date",
     "f_phone_number","f_follow_up","f_action","f_alp"].forEach(id => {
      document.getElementById(id).value = "";
    });
    document.getElementById("modalMsg").innerText = "";
  }

  async function saveEntry() {
    const name = document.getElementById("f_insured_name").value.trim();
    const msg  = document.getElementById("modalMsg");
    if (!name) { msg.innerText = "Insured name is required."; return; }

    const payload = {
      insured_name:  name,
      policy_number: document.getElementById("f_policy_number").value.trim(),
      remarks:       document.getElementById("f_remarks").value.trim(),
      date:          document.getElementById("f_date").value,
      phone_number:  document.getElementById("f_phone_number").value.trim(),
      follow_up:     document.getElementById("f_follow_up").value.trim(),
      action:        document.getElementById("f_action").value.trim(),
      alp:           document.getElementById("f_alp").value.trim()
    };

    try {
      const url    = editingId ? `/quality/${editingId}` : "/quality";
      const method = editingId ? "PUT" : "POST";
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json", Authorization: "Bearer " + TOKEN },
        body: JSON.stringify(payload)
      });
      if (res.ok) {
        closeModal();
        showToast(editingId ? "Entry updated!" : "Entry added!");
        loadEntries();
      } else {
        const d = await res.json();
        msg.innerText = d.detail || "Failed to save.";
      }
    } catch { msg.innerText = "Server error."; }
  }

  function deleteEntry(id, name) {
    showConfirm(
      "Delete the entry for <strong>" + esc(name) + "</strong>? This cannot be undone.",
      async function() {
        try {
          const res = await fetch(`/quality/${id}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + TOKEN }
          });
          if (res.ok) { showToast(name + " deleted."); loadEntries(); }
          else showToast("Failed to delete.", "error");
        } catch { showToast("Server error.", "error"); }
      },
      { confirmText: "Delete" }
    );
  }

  // ── Helpers ────────────────────────────────────────────────
  function esc(str) {
    if (!str) return "";
    return String(str)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  }

  function fmtDate(d) {
    if (!d) return "";
    try {
      return new Date(d + (d.length === 10 ? "T00:00" : ""))
        .toLocaleDateString("en-CA");
    } catch { return d; }
  }

  // Close on backdrop click
  document.getElementById("qualityModal").addEventListener("click", function(e) {
    if (e.target === this) closeModal();
  });

  loadEntries();
</script>
</body>
</html>