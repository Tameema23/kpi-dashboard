<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KPI Login</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      KPI Dashboard
    </span>
  </div>
</div>

<div class="page center">
  <div class="card auth-card">

    <div class="auth-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      <span>KPI Dashboard</span>
    </div>

    <h2 id="formTitle">Welcome Back</h2>
    <p class="auth-subtitle" id="formSubtitle">Sign in to your account</p>

    <div class="auth-input-group">
      <label>Username</label>
      <input id="username" placeholder="Enter your username" autocomplete="username">
    </div>

    <div class="auth-input-group">
      <label>Password</label>
      <div class="pw-field-wrap">
      <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password">
      <button type="button" class="pw-toggle-btn" onclick="togglePw('password', this)" title="Show password"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
    </div>
    </div>

    <label class="remember-row" id="rememberRow">
      <input type="checkbox" id="rememberMe" checked>
      <span>Keep me signed in</span>
    </label>

    <button class="btn auth-btn" onclick="submitAuth()">Sign In</button>

    <p class="switch" onclick="toggleForm()" id="switchBtn">Don't have an account? Create one</p>
    <p id="msg"></p>

  </div>
</div>

<script>
let isSignup = false;

function toggleForm() {
  isSignup = !isSignup;
  document.getElementById("formTitle").innerText = isSignup ? "Create Account" : "Welcome Back";
  document.getElementById("formSubtitle").innerText = isSignup ? "Set up your account" : "Sign in to your account";
  document.querySelector(".auth-btn").innerText = isSignup ? "Create Account" : "Sign In";
  document.getElementById("switchBtn").innerText = isSignup ? "Already have an account? Sign in" : "Don't have an account? Create one";
  document.getElementById("rememberRow").style.display = isSignup ? "none" : "flex";
  document.getElementById("msg").innerText = "";
}

async function submitAuth() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;
  const msg = document.getElementById("msg");

  if (!username || !password) {
    msg.innerText = "Please fill in all fields.";
    msg.style.color = "#dc2626";
    return;
  }

  const url = isSignup ? "/create-user" : "/login";

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    if (!res.ok) {
      msg.innerText = isSignup ? "Username already exists." : "Invalid username or password.";
      msg.style.color = "#dc2626";
      return;
    }

    if (isSignup) {
      msg.innerText = "Account created. You can now sign in.";
      msg.style.color = "#16a34a";
      setTimeout(toggleForm, 1400);
      return;
    }

    const data = await res.json();
    localStorage.setItem("token", data.token);
    localStorage.setItem("username", username);
    localStorage.setItem("role", data.role || "admin");
    if ((data.role || "admin") === "assistant") {
      window.location.href = "/planner.html";
    } else if (data.role === "quality_assistant") {
      window.location.href = "/quality.html";
    } else {
      window.location.href = "/index.html";
    }

  } catch {
    msg.innerText = "Server error. Please try again.";
    msg.style.color = "#dc2626";
  }
}


function togglePw(inputId, btn) {
  var inp = document.getElementById(inputId);
  var showing = inp.type === 'text';
  inp.type = showing ? 'password' : 'text';
  btn.innerHTML = showing ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
  btn.title = showing ? 'Show password' : 'Hide password';
}

document.addEventListener("keydown", e => { if (e.key === "Enter") submitAuth(); });
</script>
</body>
</html>