<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
  <title>Weekly Planner</title>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      KPI Dashboard
    </span>
    <!-- Admin nav -->
    <nav class="topbar-nav" id="admin-nav" style="display:none;">
      <a href="/index.html">Home</a>
      <a href="/log.html">Log Day</a>
      <a href="/reports.html">Reports</a>
      <a href="/history.html">History</a>
      <a href="/planner.html" class="active">Planner</a>
      <a href="/settings.html">Settings</a>
    </nav>
    <!-- Assistant nav -->
    <nav class="topbar-nav" id="assistant-nav" style="display:none;">
      <a href="/planner.html" class="active">Planner</a>
    </nav>
  </div>
  <div class="topbar-right">
    <span class="topbar-user">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span id="username-text"></span>
    </span>
    <button class="logout" onclick="logout()">Sign Out</button>
  </div>
</div>

<div class="page" style="padding-bottom: 60px;">

  <div class="planner-header">
    <div class="planner-week-nav">
      <button class="planner-nav-btn" id="prevWeekBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <div class="planner-week-label" id="weekLabel">Week</div>
      <button class="planner-nav-btn" id="nextWeekBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
    <button class="btn small" id="todayBtn">Today</button>
    <button class="btn" id="newApptBtn">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New Appointment
    </button>
  </div>

  <div class="planner-wrap">
    <div class="planner-grid" id="plannerGrid"></div>
  </div>

</div>

<!-- MODAL -->
<div class="modal-backdrop hidden" id="modalBackdrop">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 id="modalTitle">New Appointment</h3>
      <button class="modal-close" id="modalCloseBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label>Lead Name <span style="color:#dc2626">*</span></label>
        <input id="m_lead_name" placeholder="Enter lead name" type="text">
      </div>
      <div class="form-field">
        <label>Appointment Date &amp; Time</label>
        <div class="datetime-row">
          <input id="m_date" type="date">
          <input id="m_time" type="time" step="900">
        </div>
      </div>
      <!-- Mini calendar -->
      <div class="mini-cal-wrap">
        <div class="mini-cal-header">
          <button type="button" id="calPrevBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <span id="calMonthLabel"></span>
          <button type="button" id="calNextBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>
        <div class="mini-cal-grid" id="miniCalGrid"></div>
      </div>
      <div class="form-field">
        <label>Comments / Notes</label>
        <textarea id="m_comments" rows="3" placeholder="Any notes about this lead..."></textarea>
      </div>
      <div class="modal-booked-at hidden" id="modalBookedAt">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Booked at: <span id="modalBookedAtVal"></span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" style="background:#f1f5f9;color:#475569;" id="modalCancelBtn">Cancel</button>
      <button class="btn" id="modalSaveBtn">Save Appointment</button>
      <button class="btn" id="modalDeleteBtn" style="background:#ef4444;display:none;">Delete</button>
    </div>
  </div>
</div>

<!-- TOOLTIP -->
<div class="appt-tooltip hidden" id="apptTooltip"></div>

<!-- Mobile Bottom Nav — admin only -->
<nav class="bottom-nav" id="adminBottomNav" style="display:none;">
  <div class="bottom-nav-items">
    <a href="/index.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home
    </a>
    <a href="/log.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Log
    </a>
    <a href="/reports.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Reports
    </a>
    <a href="/planner.html" class="bottom-nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Planner
    </a>
  </div>
</nav>

<script src="/static/app.js"></script>
<script>
// ─── Everything uses TOKEN and API already declared in app.js ───

(function () {

  // ── Role & UI setup ──────────────────────────────────────────
  var role = localStorage.getItem("role") || "admin";
  document.getElementById("username-text").innerText = localStorage.getItem("username") || "";

  if (role === "assistant") {
    document.getElementById("assistant-nav").style.display = "flex";
  } else {
    document.getElementById("admin-nav").style.display = "flex";
    document.getElementById("adminBottomNav").style.display = "flex";
  }

  // ── State ────────────────────────────────────────────────────
  var appointments = [];
  var editingId    = null;
  var calYear, calMonth;
  var currentWeekStart = getWeekStart(new Date());

  // ── Week helpers (Wed–Tue) ───────────────────────────────────
  function getWeekStart(date) {
    var d   = new Date(date);
    var day = d.getDay();
    var diff = (day >= 3) ? day - 3 : day + 4;
    d.setDate(d.getDate() - diff);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function getWeekDays(start) {
    var days = [];
    for (var i = 0; i < 7; i++) {
      var d = new Date(start);
      d.setDate(start.getDate() + i);
      days.push(d);
    }
    return days;
  }

  function fmtDate(d) {
    return d.toLocaleDateString("en-CA");
  }

  function fmtDisplay(dateStr) {
    var d = new Date(dateStr + "T00:00:00");
    return d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" });
  }

  function fmtTime(t) {
    if (!t) return "";
    var parts = t.split(":");
    var h = parseInt(parts[0]);
    var m = parts[1];
    var ampm = h >= 12 ? "PM" : "AM";
    var h12  = h % 12 || 12;
    return h12 + ":" + m + " " + ampm;
  }

  function fmtDateTime(iso) {
    if (!iso) return "";
    var parts = iso.split("T");
    return fmtDisplay(parts[0]) + " at " + fmtTime(parts[1]);
  }

  // ── Week navigation ──────────────────────────────────────────
  document.getElementById("prevWeekBtn").addEventListener("click", function () {
    currentWeekStart = new Date(currentWeekStart);
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderPlanner();
  });

  document.getElementById("nextWeekBtn").addEventListener("click", function () {
    currentWeekStart = new Date(currentWeekStart);
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderPlanner();
  });

  document.getElementById("todayBtn").addEventListener("click", function () {
    currentWeekStart = getWeekStart(new Date());
    renderPlanner();
  });

  document.getElementById("newApptBtn").addEventListener("click", function () {
    openAddModal(null, null);
  });

  // ── Load appointments ────────────────────────────────────────
  async function loadAppointments() {
    try {
      var res = await fetch(API + "/appointments", {
        headers: { Authorization: "Bearer " + TOKEN }
      });
      if (res.ok) appointments = await res.json();
    } catch (e) {
      console.error("Failed to load appointments", e);
    }
    renderPlanner();
  }

  // ── Render grid ──────────────────────────────────────────────
  var HOURS = [];
  for (var h = 7; h <= 21; h++) HOURS.push(h);

  function renderPlanner() {
    var days   = getWeekDays(currentWeekStart);
    var start  = days[0].toLocaleDateString("en-US", { month: "short", day: "numeric" });
    var end    = days[6].toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
    document.getElementById("weekLabel").innerText = start + " \u2013 " + end;

    var grid = document.getElementById("plannerGrid");
    grid.innerHTML = "";

    var today = fmtDate(new Date());

    // Header row
    var headerRow = document.createElement("div");
    headerRow.className = "pg-header-row";

    var gutterHead = document.createElement("div");
    gutterHead.className = "pg-gutter-head";
    headerRow.appendChild(gutterHead);

    days.forEach(function (day) {
      var cell = document.createElement("div");
      cell.className = "pg-day-head" + (fmtDate(day) === today ? " pg-day-today" : "");
      cell.innerHTML =
        '<span class="pg-dow">' + day.toLocaleDateString("en-US", { weekday: "short" }) + "</span>" +
        '<span class="pg-dom">' + day.getDate() + "</span>";
      headerRow.appendChild(cell);
    });
    grid.appendChild(headerRow);

    // Hour rows
    HOURS.forEach(function (hour) {
      var row = document.createElement("div");
      row.className = "pg-row";

      var gutter = document.createElement("div");
      gutter.className = "pg-gutter";
      gutter.innerText = fmtTime(String(hour).padStart(2, "0") + ":00");
      row.appendChild(gutter);

      days.forEach(function (day) {
        var cell = document.createElement("div");
        cell.className = "pg-cell" + (fmtDate(day) === today ? " pg-cell-today" : "");

        // Click empty area to add
        cell.addEventListener("click", (function (d, hr) {
          return function () {
            openAddModal(fmtDate(d), String(hr).padStart(2, "0") + ":00");
          };
        })(day, hour));

        // Appointments in this cell
        appointments.forEach(function (appt) {
          if (!appt.scheduled_for) return;
          var parts    = appt.scheduled_for.split("T");
          var apptDate = parts[0];
          var apptHour = parseInt((parts[1] || "0").split(":")[0]);
          if (apptDate !== fmtDate(day) || apptHour !== hour) return;

          var block = document.createElement("div");
          block.className = "pg-appt-block";
          block.innerHTML =
            '<span class="pg-appt-time">' + fmtTime(parts[1]) + "</span>" +
            '<span class="pg-appt-name">' + appt.lead_name + "</span>";

          block.addEventListener("mouseenter", function (e) { showTooltip(e, appt); });
          block.addEventListener("mouseleave", hideTooltip);
          block.addEventListener("click", function (e) {
            e.stopPropagation();
            openEditModal(appt);
          });

          cell.appendChild(block);
        });

        row.appendChild(cell);
      });

      grid.appendChild(row);
    });
  }

  // ── Tooltip ──────────────────────────────────────────────────
  function showTooltip(e, appt) {
    var tip = document.getElementById("apptTooltip");
    tip.innerHTML =
      '<div class="tip-name">' + appt.lead_name + "</div>" +
      '<div class="tip-row"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' + fmtDateTime(appt.scheduled_for) + "</div>" +
      (appt.comments ? '<div class="tip-row tip-comments">' + appt.comments + "</div>" : "") +
      '<div class="tip-row tip-meta">Booked ' + fmtDateTime(appt.booked_at) + " by " + appt.created_by + "</div>";
    tip.classList.remove("hidden");
    positionTooltip(e);
  }

  function positionTooltip(e) {
    var tip  = document.getElementById("apptTooltip");
    var tipW = 260;
    var x    = e.clientX + 12;
    var y    = e.clientY - 10;
    tip.style.left = (x + tipW > window.innerWidth ? x - tipW - 24 : x) + "px";
    tip.style.top  = y + "px";
  }

  function hideTooltip() {
    document.getElementById("apptTooltip").classList.add("hidden");
  }

  document.addEventListener("mousemove", function (e) {
    var tip = document.getElementById("apptTooltip");
    if (!tip.classList.contains("hidden")) positionTooltip(e);
  });

  // ── Modal: open add ──────────────────────────────────────────
  function openAddModal(dateStr, timeStr) {
    editingId = null;
    document.getElementById("modalTitle").innerText = "New Appointment";
    document.getElementById("m_lead_name").value = "";
    document.getElementById("m_comments").value  = "";
    document.getElementById("m_date").value = dateStr || fmtDate(new Date());
    document.getElementById("m_time").value = timeStr || "09:00";
    document.getElementById("modalBookedAt").classList.add("hidden");
    document.getElementById("modalDeleteBtn").style.display = "none";
    document.getElementById("modalSaveBtn").innerText = "Save Appointment";

    var d = dateStr ? new Date(dateStr + "T00:00:00") : new Date();
    calYear  = d.getFullYear();
    calMonth = d.getMonth();
    renderMiniCal();

    document.getElementById("modalBackdrop").classList.remove("hidden");
    document.getElementById("m_lead_name").focus();
  }

  // ── Modal: open edit ─────────────────────────────────────────
  function openEditModal(appt) {
    editingId = appt.id;
    document.getElementById("modalTitle").innerText = "Edit Appointment";
    document.getElementById("m_lead_name").value = appt.lead_name;
    document.getElementById("m_comments").value  = appt.comments || "";

    var parts = (appt.scheduled_for || "T").split("T");
    document.getElementById("m_date").value = parts[0] || "";
    document.getElementById("m_time").value = parts[1] || "09:00";

    document.getElementById("modalBookedAt").classList.remove("hidden");
    document.getElementById("modalBookedAtVal").innerText = fmtDateTime(appt.booked_at) + " by " + appt.created_by;
    document.getElementById("modalDeleteBtn").style.display = "inline-flex";
    document.getElementById("modalSaveBtn").innerText = "Update";

    var d = parts[0] ? new Date(parts[0] + "T00:00:00") : new Date();
    calYear  = d.getFullYear();
    calMonth = d.getMonth();
    renderMiniCal();

    document.getElementById("modalBackdrop").classList.remove("hidden");
  }

  function closeModal() {
    document.getElementById("modalBackdrop").classList.add("hidden");
    hideTooltip();
  }

  document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
  document.getElementById("modalCancelBtn").addEventListener("click", closeModal);
  document.getElementById("modalBackdrop").addEventListener("click", function (e) {
    if (e.target === this) closeModal();
  });

  // ── Save ─────────────────────────────────────────────────────
  document.getElementById("modalSaveBtn").addEventListener("click", async function () {
    var lead_name = document.getElementById("m_lead_name").value.trim();
    if (!lead_name) {
      var inp = document.getElementById("m_lead_name");
      inp.style.borderColor = "#dc2626";
      inp.focus();
      setTimeout(function () { inp.style.borderColor = ""; }, 1500);
      return;
    }

    var date     = document.getElementById("m_date").value;
    var time     = document.getElementById("m_time").value;
    var comments = document.getElementById("m_comments").value.trim();

    if (!date || !time) {
      showToast("Please select a date and time.", "error");
      return;
    }

    var payload = { lead_name: lead_name, comments: comments, scheduled_for: date + "T" + time };

    try {
      var res;
      if (editingId) {
        res = await fetch(API + "/appointments/" + editingId, {
          method: "PUT",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + TOKEN },
          body: JSON.stringify(payload)
        });
      } else {
        res = await fetch(API + "/appointments", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + TOKEN },
          body: JSON.stringify(payload)
        });
      }

      if (res.ok) {
        showToast(editingId ? "Appointment updated!" : "Appointment booked!");
        closeModal();
        await loadAppointments();
      } else {
        showToast("Failed to save. Please try again.", "error");
      }
    } catch (e) {
      showToast("Server error.", "error");
    }
  });

  // ── Delete ───────────────────────────────────────────────────
  document.getElementById("modalDeleteBtn").addEventListener("click", async function () {
    if (!editingId) return;
    if (!confirm("Delete this appointment?")) return;
    try {
      var res = await fetch(API + "/appointments/" + editingId, {
        method: "DELETE",
        headers: { Authorization: "Bearer " + TOKEN }
      });
      if (res.ok) {
        showToast("Appointment deleted.");
        closeModal();
        await loadAppointments();
      } else {
        showToast("Delete failed.", "error");
      }
    } catch (e) {
      showToast("Server error.", "error");
    }
  });

  // ── Mini calendar ────────────────────────────────────────────
  var CAL_DAYS = ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"];

  function renderMiniCal() {
    document.getElementById("calMonthLabel").innerText =
      new Date(calYear, calMonth, 1).toLocaleDateString("en-US", { month: "long", year: "numeric" });

    var grid = document.getElementById("miniCalGrid");
    grid.innerHTML = "";

    CAL_DAYS.forEach(function (d) {
      var h = document.createElement("div");
      h.className = "mc-dow";
      h.innerText = d;
      grid.appendChild(h);
    });

    var firstDay    = new Date(calYear, calMonth, 1).getDay();
    var daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
    var selectedDate = document.getElementById("m_date").value;
    var todayStr    = fmtDate(new Date());

    for (var i = 0; i < firstDay; i++) {
      var blank = document.createElement("div");
      blank.className = "mc-blank";
      grid.appendChild(blank);
    }

    for (var day = 1; day <= daysInMonth; day++) {
      var d = document.createElement("div");
      var dateStr = calYear + "-" + String(calMonth + 1).padStart(2, "0") + "-" + String(day).padStart(2, "0");
      d.className = "mc-day";
      if (dateStr === todayStr)     d.classList.add("mc-today");
      if (dateStr === selectedDate) d.classList.add("mc-selected");
      d.innerText = day;
      d.addEventListener("click", (function (ds) {
        return function () {
          document.getElementById("m_date").value = ds;
          renderMiniCal();
        };
      })(dateStr));
      grid.appendChild(d);
    }
  }

  document.getElementById("calPrevBtn").addEventListener("click", function () {
    calMonth--;
    if (calMonth < 0) { calMonth = 11; calYear--; }
    renderMiniCal();
  });

  document.getElementById("calNextBtn").addEventListener("click", function () {
    calMonth++;
    if (calMonth > 11) { calMonth = 0; calYear++; }
    renderMiniCal();
  });

  document.getElementById("m_date").addEventListener("change", function () {
    if (this.value) {
      var d = new Date(this.value + "T00:00:00");
      calYear  = d.getFullYear();
      calMonth = d.getMonth();
      renderMiniCal();
    }
  });

  // ── Init ─────────────────────────────────────────────────────
  loadAppointments();

})(); // end IIFE
</script>
</body>
</html>