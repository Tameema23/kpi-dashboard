<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/static/style.css">
  <title>Weekly Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <span class="topbar-brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      KPI Dashboard
    </span>
    <nav class="topbar-nav">
      <a href="/index.html" class="admin-only">Home</a>
      <a href="/log.html" class="admin-only">Log Day</a>
      <a href="/reports.html" class="active">Reports</a>
      <a href="/history.html" class="admin-only">History</a>
      <a href="/planner.html" class="admin-only">Planner</a>
      <a href="/quality.html" class="admin-only">Quality</a>
      <a href="/settings.html" class="admin-only">Settings</a>
    </nav>
  </div>
  <div class="topbar-right">
    <span class="topbar-user">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span id="username-text"></span>
    </span>
    <button class="logout" onclick="logout()">Sign Out</button>
  </div>
</div>

<div class="page">

  <div class="reports-header">
    <button class="btn export-btn" onclick="exportExcel()">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export CSV
    </button>
  </div>

  <!-- KPI CARDS -->
  <div class="kpi-grid-3" id="kpi-skeleton-grid">
    <!-- Skeletons shown while loading -->
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
    <div class="kpi-card skeleton skeleton-kpi"></div>
  </div>

  <div class="kpi-grid-3 hidden" id="kpi-real-grid">
    <div class="kpi-card">
      <div class="kpi-icon icon-blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Presentations</span><b id="wk_pres">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><path d="M12 22V7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Sales</span><b id="wk_sales">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">YTD Total ALP</span><b id="wk_ytd_alp">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-amber"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Show Ratio</span><b id="wk_show">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Closing %</span><b id="wk_close">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">ALP / Sale</span><b id="wk_alp">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Conversion Ratio</span><b id="wk_conv">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Bad Lead Ratio</span><b id="wk_bad_lead">—</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon icon-purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
      <div class="kpi-text"><span class="kpi-label">Refs / Pres</span><b id="wk_refs">—</b></div>
    </div>
  </div>

  <!-- WEEKLY PERFORMANCE -->
  <h2 class="section-title">Weekly Performance</h2>
  <section class="chart-grid-2" id="charts-skeleton">
    <div class="skeleton skeleton-chart"></div>
    <div class="skeleton skeleton-chart"></div>
  </section>
  <section class="chart-grid-2 hidden" id="charts-real">
    <div class="card chart-card"><canvas id="salesChart"></canvas></div>
    <div class="card chart-card"><canvas id="presentationsChart"></canvas></div>
  </section>
  <section class="chart-grid-1">
    <div class="card chart-card">
      <div style="position:relative; height:300px;">
        <canvas id="showRatioChart"></canvas>
      </div>
    </div>
  </section>

  <!-- YTD RATIOS -->
  <h2 class="section-title">Year-to-Date Ratios</h2>
  <section class="chart-grid-2">
    <div class="card chart-card"><div style="position:relative; height:300px;"><canvas id="closingPieChart"></canvas></div></div>
    <div class="card chart-card"><div style="position:relative; height:300px;"><canvas id="showRatioPieChart"></canvas></div></div>
  </section>

  <!-- YTD TRENDS -->
  <h2 class="section-title">Year-to-Date Trends</h2>
  <section class="chart-grid-2">
    <div class="card chart-card"><canvas id="salesClosingYTD"></canvas></div>
    <div class="card chart-card"><canvas id="alpYTDChart"></canvas></div>
  </section>

  <!-- LEAD RATIOS -->
  <h2 class="section-title">Lead Ratios</h2>
  <section class="chart-grid-1">
    <div class="card chart-card">
      <div class="lead-ratio-controls">
        <button class="btn small lead-ratio-toggle active" data-period="ytd">YTD</button>
        <button class="btn small lead-ratio-toggle" data-period="q1">Q1</button>
        <button class="btn small lead-ratio-toggle" data-period="q2">Q2</button>
        <button class="btn small lead-ratio-toggle" data-period="q3">Q3</button>
        <button class="btn small lead-ratio-toggle" data-period="q4">Q4</button>
      </div>
      <div style="position:relative; height:320px;">
        <canvas id="leadRatioChart"></canvas>
      </div>
    </div>
  </section>

</div>

<nav class="bottom-nav">
  <div class="bottom-nav-items">
    <a href="/index.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
    <a href="/log.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Log
    </a>
    <a href="/reports.html" class="bottom-nav-item active">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reports
    </a>
    <a href="/history.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      History
    </a>
    <a href="/planner.html" class="bottom-nav-item">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      Planner
    </a>
    <a href="/quality.html" class="bottom-nav-item admin-only">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
      Quality
    </a>
  </div>
</nav>

<script src="/static/app.js"></script>
<script>
  // Role-based nav
  if (localStorage.getItem("role") === "assistant" || localStorage.getItem("role") === "quality_assistant") {
    document.querySelectorAll(".admin-only").forEach(function(el) { el.style.display = "none"; });
  }
  const u = localStorage.getItem("username");
  if (u) document.getElementById("username-text").innerText = u;
  loadWeekly();
</script>
</body>
</html>